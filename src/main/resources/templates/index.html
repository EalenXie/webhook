<!DOCTYPE html>
<html lang="zh">
<head>
    <meta charset="UTF-8">
    <title>Webhook & Pipeline 控制台</title>
    <link rel="stylesheet" href="/styles.css">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <!-- Vue CDN -->
    <script src="https://unpkg.com/vue@3/dist/vue.global.prod.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/marked/marked.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/sockjs-client@1/dist/sockjs.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/stompjs@2.3.3/lib/stomp.min.js"></script>
</head>

<body>
<header>
    Webhook 控制台
</header>

<div id="app" class="container">
    <div class="card">
        <h2>Webhook 配置列表</h2>
        <div v-if="loadingWebhooks" class="loading">加载中...</div>
        <div v-if="webhookError" class="error">{{ webhookError }}</div>
        <table v-if="!loadingWebhooks && webhooks.length">
            <thead>
            <tr>
                <th>类型</th>
                <th>ID</th>
                <th>Webhook 地址</th>
                <th>Webhook Server Host</th>
                <th>触发事件</th>
                <th>触发分支</th>
                <th>触发项目</th>
            </tr>
            </thead>

            <tbody>
            <tr v-for="w in webhooks" :key="w.id">
                <td>
                  <span class="type-cell">
                    <img v-if="w.type === 'GITLAB'"
                         src="https://about.gitlab.com/images/press/logo/png/gitlab-icon-rgb.png" class="type-logo"
                         alt="GitLab">
                    <img v-else-if="w.type === 'GITHUB'"
                         src="https://github.githubassets.com/images/modules/logos_page/GitHub-Mark.png"
                         class="type-logo" alt="GitHub">
                    {{ w.type }}
                  </span>
                </td>
                <td><strong>{{ w.id }}</strong></td>
                <td style="position: relative;">
                    <span v-if="w.webhookUrl" class="tag url-tag copy-url"
                          @click="copyToClipboard(w.webhookUrl)"
                          :title="w.webhookUrl">{{ w.webhookUrl }}</span>
                    <span v-else class="tag disabled">未配置</span>
                    <span v-if="w.copied" class="copy-tooltip">已复制</span>
                </td>
                <td>
                    <a v-if="w.host" :href="w.host" target="_blank" rel="noopener noreferrer"
                       class="host-link">
                        {{ w.host }}
                    </a>
                    <span v-else class="tag disabled">未配置</span>
                </td>
                <td>
                    <div class="tag-group">
                        <template v-if="w.triggers && w.triggers.length > 0">
                            <span v-for="e in w.triggers" :key="e" class="tag scope">{{ e }}</span>
                        </template>
                        <template v-else>
                            <span class="tag disabled">未配置</span>
                        </template>
                    </div>
                </td>
                <td>
                    <div class="tag-group">
                        <template v-if="w.onlyRefs && w.onlyRefs.length > 0">
                            <span v-for="e in w.onlyRefs" :key="e" class="tag scope">{{ e }}</span>
                        </template>
                        <template v-else>
                            <span class="tag disabled">未配置</span>
                        </template>
                    </div>
                </td>
                <td>
                    <div class="tag-group">
                        <template v-if="w.webUrls && w.webUrls.length > 0">
                            <a v-for="url in w.webUrls"
                               :key="url"
                               :href="url.startsWith('http') ? url : 'https://' + url"
                               target="_blank"
                               rel="noopener noreferrer"
                               class="tag url-tag"
                               :title="url">{{ url }}</a>
                        </template>
                        <template v-else>
                            <span class="tag disabled">未配置</span>
                        </template>
                    </div>
                </td>
            </tr>
            </tbody>
        </table>
    </div>

    <div class="card">
        <h2>Webhook 实时消息</h2>

        <div class="log-panel" ref="logContainer">
            <div class="log-header">实时日志流</div>
            <div class="log-content">
                <div v-for="log in messages" class="log-row-split">
                    <!-- 左侧元信息 -->
                    <div class="log-meta">
                        <div class="meta-time">{{ log.timeStamp }}</div>
                        <!-- 类型和标题在同一行 -->
                        <div class="meta-header">
                            <div class="meta-type">{{ log.type }}</div>
                            <div class="meta-title">{{ log.title }}</div>
                        </div>
                        <!-- 通知和通知人在同一行 -->
                        <div v-if="log.notifies?.length" class="meta-notify">
                            <span class="notify-label">通知：</span>
                            <div class="notify-tags">
                                <span class="notify-tag" v-for="n in log.notifies">{{ n }}</span>
                            </div>
                        </div>
                    </div>
                    <!-- 右侧 Markdown 内容 -->
                    <div class="markdown-tight" v-html="renderMarkdown(log.message)"></div>
                </div>
            </div>
        </div>
    </div>
</div>

<script src="/app.js">

</script>
</body>
</html>