<!DOCTYPE html>
<html lang="zh">
<head>
    <meta charset="UTF-8">
    <title>Webhook & Pipeline æ§åˆ¶å°</title>
    <meta name="viewport" content="width=device-width, initial-scale=1">

    <!-- Vue CDN -->
    <script src="https://unpkg.com/vue@3/dist/vue.global.prod.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/marked/marked.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/sockjs-client@1/dist/sockjs.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/stompjs@2.3.3/lib/stomp.min.js"></script>

    <style>
        body {
            margin: 0;
            font-family: "Segoe UI", Roboto, Arial;
            background: #f5f7fb;
            color: #333;
        }

        header {
            background: #1f2937;
            color: white;
            padding: 16px 24px;
            font-size: 20px;
            font-weight: bold;
        }

        .container {
            padding: 20px;
        }

        .card {
            background: white;
            border-radius: 12px;
            padding: 16px;
            box-shadow: 0 8px 24px rgba(0, 0, 0, 0.05);
            margin-bottom: 20px;
        }

        h2 {
            margin: 0 0 12px;
            font-size: 18px;
        }

        table {
            width: 100%;
            border-collapse: collapse;
        }

        th, td {
            padding: 10px;
            text-align: left;
            border-bottom: 1px solid #eee;
            font-size: 14px;
        }

        th {
            background: #f8fafc;
        }

        .tag {
            display: inline-block;
            padding: 4px 10px;
            border-radius: 16px;
            font-size: 12px;
            margin-right: 4px;
        }

        .tag.success {
            background: #d1fae5;
            color: #065f46;
        }

        .tag.running {
            background: #dbeafe;
            color: #1d4ed8;
        }

        .tag.failed {
            background: #fee2e2;
            color: #991b1b;
        }

        .tag.disabled {
            background: #f3f4f6;
            color: #6b7280;
        }

        .tag.scope {
            background: #eef2ff;
            color: #3730a3;
        }

        .loading {
            text-align: center;
            padding: 12px;
            color: #666;
        }

        .error {
            color: red;
            text-align: center;
            padding: 10px;
        }

        .tag-group {
            display: flex;
            flex-wrap: wrap; /* å…è®¸æ¢è¡Œ */
            gap: 6px;
            max-width: 100%; /* é™åˆ¶åœ¨ td å†…å®½åº¦ */
            word-break: break-word; /* è¶…é•¿ URL æŠ˜è¡Œ */
            white-space: normal; /* é˜»æ­¢ nowrap */
        }

        .type-cell {
            display: flex;
            align-items: center; /* å‚ç›´å±…ä¸­ */
            gap: 8px; /* logo å’Œæ–‡å­—é—´è· */
            font-weight: bold;
            font-size: 14px;
        }

        .type-logo {
            width: 24px; /* åŸæ¥æ˜¯ 18px */
            height: 24px; /* åŸæ¥æ˜¯ 18px */
            display: inline-block;
        }

        .host-link {
            color: #2563eb;
            text-decoration: underline;
            font-weight: 500;
            font-size: 13px;
            word-break: break-all; /* URL å¤ªé•¿è‡ªåŠ¨æ¢è¡Œ */
        }

        .host-link:hover {
            color: #1d4ed8;
        }

        .tag-group {
            display: flex;
            flex-wrap: wrap; /* æ”¯æŒæ¢è¡Œ */
            gap: 6px;
            max-width: 100%;
        }

        .url-tag {
            background: #eef2ff;
            color: #3730a3;
            font-size: 12px;
            padding: 4px 8px;
            border-radius: 8px;
            text-decoration: none; /* é“¾æ¥å»æ‰ä¸‹åˆ’çº¿ */
            word-break: break-all;
            transition: background 0.2s;
        }

        .url-tag:hover {
            background: #e0e7ff; /* hover é«˜äº® */
        }

        .copy-url {
            cursor: pointer;
            background: #fef3c7;
            color: #b45309;
            padding: 4px 8px;
            border-radius: 8px;
            font-size: 12px;
            word-break: break-all;
            transition: background 0.2s;
        }

        .copy-url:hover {
            background: #fde68a;
        }

        .copy-tooltip {
            position: absolute;
            top: -22px;
            left: 0;
            background: #111;
            color: #fff;
            padding: 2px 6px;
            font-size: 11px;
            border-radius: 4px;
            white-space: nowrap;
            opacity: 0.9;
            pointer-events: none;
        }


        .log-panel {
            height: 420px;
            overflow-y: auto;
            background: #ffffff; /* ç™½åº• */
            padding: 10px 12px;
            border-radius: 10px;
            border: 1px solid #e5e7eb;
            font-family: "JetBrains Mono", "Fira Code", "Consolas", monospace;
            font-size: 13px;
            color: #111827;
        }

        /* å•æ¡æ—¥å¿— */
        .log-row {
            margin-bottom: 10px;
        }

        /* ç¬¬ä¸€è¡Œï¼šæ—¶é—´ + ç±»å‹ + æ ‡é¢˜ */
        .log-line {
            display: flex;
            gap: 10px;
            align-items: center;
            white-space: nowrap;
            font-size: 13px;
        }

        .log-time {
            color: #6b7280;
            font-size: 12px;
            min-width: 140px;
        }

        .log-type {
            background: #eff6ff;
            color: #2563eb;
            padding: 1px 8px;
            border-radius: 999px;
            font-size: 11px;
            font-weight: 600;
        }

        .log-title {
            font-weight: 600;
            color: #111827;
        }

        /* Markdown å†…å®¹ï¼ˆæ§åˆ¶å°å—ï¼‰ */
        .log-body {
            margin-top: 3px;
            margin-left: 150px; /* å¯¹é½æ—¶é—´åˆ— */
            padding: 6px 8px;
            background: #f9fafb; /* å¾ˆæµ…çš„ç° */
            border-left: 3px solid #e5e7eb;
            line-height: 1.5;
            white-space: pre-wrap;
            color: #1f2937;
            font-family: inherit;
            border-radius: 4px;
        }

        /* Markdown å†…éƒ¨ */
        .log-body code {
            background: #eef2ff;
            padding: 1px 4px;
            border-radius: 4px;
            color: #4338ca;
        }

        .log-body strong {
            color: #111827;
            font-weight: 600;
        }

        /* é€šçŸ¥äºº */
        .log-notify {
            margin-left: 150px;
            margin-top: 4px;
            font-size: 12px;
            color: #6b7280;
        }

        .tag {
            background: #f1f5f9;
            padding: 2px 6px;
            border-radius: 999px;
            margin-right: 4px;
        }

    </style>
</head>

<body>

<header>
    ğŸš€ Webhook æ§åˆ¶å°
</header>

<div id="app" class="container">
    <div class="card">
        <h2>Webhook é…ç½®åˆ—è¡¨</h2>

        <div v-if="loadingWebhooks" class="loading">åŠ è½½ä¸­...</div>
        <div v-if="webhookError" class="error">{{ webhookError }}</div>

        <table v-if="!loadingWebhooks && webhooks.length">
            <thead>
            <tr>
                <th>ç±»å‹</th>
                <th>ID</th>
                <th>Webhook åœ°å€</th>
                <th>Webhook Server Host</th>
                <th>è§¦å‘äº‹ä»¶</th>
                <th>è§¦å‘åˆ†æ”¯</th>
                <th>è§¦å‘é¡¹ç›®</th>
            </tr>
            </thead>

            <tbody>
            <tr v-for="w in webhooks" :key="w.id">
                <td>
                  <span class="type-cell">
                    <img v-if="w.type === 'GITLAB'"
                         src="https://about.gitlab.com/images/press/logo/png/gitlab-icon-rgb.png" class="type-logo"
                         alt="GitLab">
                    <img v-else-if="w.type === 'GITHUB'"
                         src="https://github.githubassets.com/images/modules/logos_page/GitHub-Mark.png"
                         class="type-logo" alt="GitHub">
                    {{ w.type }}
                  </span>
                </td>
                <td><strong>{{ w.id }}</strong></td>
                <td style="position: relative;"><span v-if="w.webhookUrl" class="tag url-tag copy-url"
                                                      @click="copyToClipboard(w.webhookUrl)"
                                                      :title="w.webhookUrl">{{ w.webhookUrl }}</span>
                    <span v-else class="tag disabled">æœªé…ç½®</span>
                    <span v-if="w.copied" class="copy-tooltip">å·²å¤åˆ¶</span>
                </td>
                <td>
                    <a v-if="w.host" :href="w.host" target="_blank" rel="noopener noreferrer"
                       class="host-link">
                        {{ w.host }}
                    </a>
                    <span v-else class="tag disabled">æœªé…ç½®</span>
                </td>
                <td>
                    <template v-if="w.triggers && w.triggers.length > 0">
                        <span v-for="e in w.triggers" :key="e" class="tag scope">{{ e }}</span>
                    </template>
                    <template v-else>
                        <span class="tag disabled">æœªé…ç½®</span>
                    </template>
                </td>
                <td>
                    <template v-if="w.onlyRefs && w.onlyRefs.length > 0">
                        <span v-for="e in w.onlyRefs" :key="e" class="tag scope">{{ e }}</span>
                    </template>
                    <template v-else>
                        <span class="tag disabled">æœªé…ç½®</span>
                    </template>
                </td>
                <td>
                    <div class="tag-group">
                        <template v-if="w.webUrls && w.webUrls.length > 0">
                            <a v-for="url in w.webUrls"
                               :key="url"
                               :href="url.startsWith('http') ? url : 'https://' + url"
                               target="_blank"
                               rel="noopener noreferrer"
                               class="tag url-tag"
                               :title="url">{{ url }}</a>
                        </template>
                        <template v-else>
                            <span class="tag disabled">æœªé…ç½®</span>
                        </template>
                    </div>
                </td>


            </tr>
            </tbody>
        </table>
    </div>

    <div class="card">
        <h2>Webhook å®æ—¶æ¶ˆæ¯</h2>
        <div ref="logContainer" class="log-panel">
            <div v-for="log in messages" class="log-item">
                <!-- Header Line -->
                <div class="log-line">
                    <span class="log-time">{{ log.timeStamp }}</span>
                    <span class="log-type">{{ log.type }}</span>
                    <span class="log-title">{{ log.title }}</span>
                </div>
                <!-- Markdown Body -->
                <pre class="log-body" v-html="renderMarkdown(log.message)"></pre>
                <!-- Notify -->
                <div v-if="log.notifies?.length" class="log-notify">
                    é€šçŸ¥äºº:
                    <span class="tag" v-for="n in log.notifies">{{ n }}</span>
                </div>
            </div>
        </div>
    </div>

</div>

<script>
    const {createApp} = Vue;

    createApp({
        data() {
            return {
                webhooks: [],
                loadingWebhooks: true,
                webhookError: null,
                messages: [],
                loadingMessages: false
            };
        },

        mounted() {
            this.loadWebhooks();
            this.loadHistory();
            this.connectWebSocket();
        },

        methods: {
            renderMarkdown(md) {
                if (!md) return '';
                return marked.parse(md, {
                    breaks: true,   // å•æ¢è¡Œç”Ÿæ•ˆ
                    gfm: true
                });
            },
            loadWebhooks() {
                fetch("/actuator/webhooks/configs", {
                    credentials: "include"
                })
                    .then(res => res.json())
                    .then(data => {
                        this.webhooks = data;
                        this.loadingWebhooks = false;
                    })
                    .catch(() => {
                        this.webhookError = "Webhook æ•°æ®åŠ è½½å¤±è´¥";
                        this.loadingWebhooks = false;
                    });
            },
            copyToClipboard(text) {
                if (!text) return;

                // ä¼˜å…ˆä½¿ç”¨ç°ä»£ Clipboard API
                if (navigator.clipboard && navigator.clipboard.writeText) {
                    navigator.clipboard.writeText(text)
                        .then(() => this.showCopied(text))
                        .catch(() => this.fallbackCopy(text));
                } else {
                    // fallback
                    this.fallbackCopy(text);
                }
            },
            fallbackCopy(text) {
                try {
                    const textarea = document.createElement("textarea");
                    textarea.value = text;
                    textarea.style.position = "fixed";
                    textarea.style.opacity = "0";
                    document.body.appendChild(textarea);
                    textarea.select();
                    document.execCommand("copy");
                    document.body.removeChild(textarea);
                    this.showCopied(text);
                } catch (err) {
                    console.error("å¤åˆ¶å¤±è´¥", err);
                }
            },

            showCopied(text) {
                const w = this.webhooks.find(item => item.webhookUrl === text);
                if (w) {
                    w.copied = true;
                    setTimeout(() => w.copied = false, 1500);
                }
            },


            loadHistory() {
                this.loadingMessages = true;
                fetch('/actuator/webhooks/message/history')
                    .then(res => res.json())
                    .then(data => {
                        this.messages = data.reverse(); // æ—¶é—´æ­£åº
                    })
                    .finally(() => this.loadingMessages = false);
            },

            connectWebSocket() {
                const socket = new SockJS('/ws');
                const stomp = Stomp.over(socket);

                stomp.connect({}, () => {
                    stomp.subscribe('/topic/messages', msg => {
                        this.messages.push(JSON.parse(msg.body));
                        this.scrollToBottom();
                    });
                });
            },

            scrollToBottom() {
                this.$nextTick(() => {
                    const el = this.$refs.logContainer;
                    if (el) el.scrollTop = el.scrollHeight;
                });
            }
        }
    }).mount("#app");
</script>

</body>
</html>
